#!/bin/bash

# Doily (c) 2017 Finn Ellis, licensed under MIT.
# Manage writing into daily files.
# https://github.com/relsqui/doily

set -e

# This complies with the XDG Base Directory Specification:
# https://standards.freedesktop.org/basedir-spec/basedir-spec-latest.html
CONF_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/doily"
CONF_FILE="${CONF_DIR}/doily.cfg"


if [[ -e "${CONF_FILE}" ]]; then
    source "${CONF_FILE}"
else
    mkdir -p "${CONF_DIR}"
    # This bit of magic is determining the directory where the script being
    # executed is located, across symlinks, to get to the example config.
    # Based on: http://unix.stackexchange.com/a/17500
    cp "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")/default.cfg" "${CONF_FILE}"
    cat <<EOF
Configuration file created in: ${CONF_FILE}

You can take a look if you want to view or change the default settings.
When you're ready, run \`doily\` again to write your first daily!
EOF
    exit 0
fi


if [[ -n "$public_dailies" ]]; then
    file_perms=644
    dir_perms=755
    doily_group="$USER"
elif [[ -n "$doily_group" ]]; then
    file_perms=640
    dir_perms=750
else
    file_perms=600
    dir_perms=700
    doily_group="$USER"
fi

if [[ -z "${doily_dir}" ]]; then
    echo "No storage location set for Doily!"\
         "Please set one by editing ${CONF_FILE}" 1>&2
    exit 1
elif [[ "${doily_dir}" != /* ]]; then
    # If it starts with ~, the shell will expand it before it gets here.
    echo "Your Doily directory is set to a relative path, which is"\
         "unsafe. Please change it by editing ${CONF_FILE}" 1>&2
    exit 1
elif [[ "${doily_dir}" -ef "${HOME}" ]]; then
    echo "Your Doily directory is set to your home directory, which is"\
         "unsafe. Please change it by editing ${CONF_FILE}" 1>&2
    exit 1
elif [[ ! -d "${doily_dir}" ]]; then
    mkdir -p "${doily_dir}"
fi

# Default to nano if the preferred editor is empty.
"${EDITOR:-nano}" "${doily_dir}/$(date +%F)"

# Set permissions on everything, in case the config has changed.
# (If you were wondering why the config file says not to use your home
# directory as your Doily directory, this is why.)
chmod "$dir_perms" "${doily_dir}"
chgrp "$doily_group" "${doily_dir}"

if ! find "${doily_dir}" -maxdepth 0 -empty; then
    # These will error out if the directory is empty (for example if the text
    # editor was closed without saving), so we check first.
    # The method is taken from: http://stackoverflow.com/a/91769
    chmod "$file_perms" "${doily_dir}/*"
    chgrp "$doily_group" "${doily_dir}./*"
fi

if [[ -n "${use_git}" ]]; then
    # This will usually be excessive but harmless; if use_git is newly turned
    # on, though, it ensures the repo gets created and old dailies are included.
    git -C "${doily_dir}" init
    git -C "${doily_dir}" add .
    if [[ -n "${auto_commit}" ]]; then
        git -C "${doily_dir}" commit -m "Automatic commit from Doily."
    else
        git -C "${doily_dir}" commit
    fi
fi
